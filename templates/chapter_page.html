{% extends "top_panel.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}
    <title>{{ manga.manga_name }} - Глава {{ chapter.get_chapter_display }}</title>
{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'manga_section/css/chapter_page.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            htmx.config.useTemplateFragments = true;
            
            document.body.addEventListener('htmx:configRequest', function(evt) {
                evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
            });
        });
    </script>
    
    <div class="reader_selector">
        <select onchange="changeReadingMode(this.value)">
            <option value="rtl" {% if reading_mode == 'rtl' %} selected {% endif %}>По-японски</option>
            <option value="vertical" {% if reading_mode == 'vertical' %} selected {% endif %}>Полотно</option>
        </select>
    </div>
    
    <div class="container">
    
        <div class="main_container" id="reader">
            {% if reading_mode == 'vertical' %}
                
                {% for image in images %}
                    <div class="image_block">
                        <img src="{{ image.page_image.url }}">
                    </div>
                {% endfor %}
            
            {# TODO: переписать с нуля японский режим, этот блок не работает #}
            {% elif reading_mode == 'rtl' %}
            
                {% for pair in page_pairs %}
                    {% if pair|length == 1 and pair.0.is_double_page %}
                        <!-- Одиночная страница-разворот -->
                        <div class="page-pair single-spread">
                            <img src="{{ pair.0.page_image.url }}" 
                                 alt="Page {{ pair.0.page_number }}" 
                                 class="page double-page"
                                 data-page-number="{{ pair.0.page_number }}"
                                 data-is-double="true">
                        </div>
                    {% elif pair|length == 2 %}
                        <!-- Пара обычных страниц -->
                        <div class="page-pair">
                            <img src="{{ pair.0.page_image.url }}" 
                                 alt="Page {{ pair.0.page_number }}" 
                                 class="page normal-page"
                                 data-page-number="{{ pair.0.page_number }}">
                            <img src="{{ pair.1.page_image.url }}" 
                                 alt="Page {{ pair.1.page_number }}" 
                                 class="page normal-page"
                                 data-page-number="{{ pair.1.page_number }}">
                        </div>
                    {% else %}
                        <!-- Одиночная обычная страница (последняя непарная) -->
                        <div class="page-pair">
                            <img src="{{ pair.0.page_image.url }}" 
                                 alt="Page {{ pair.0.page_number }}" 
                                 class="page normal-page"
                                 data-page-number="{{ pair.0.page_number }}">
                        </div>
                    {% endif %}
                {% endfor %}
                
            {% endif %}        
        </div>
    
        
        <div class="side_bar">
            <div class="credits">
                {% if chapter.interpreter.all %}
                    <h1>Переводчик:</h1>
                    {% for person in chapter.interpreter.all %}
                        <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% endif %}
                {% if chapter.editor.all %}
                    <h1>Редактор:</h1>
                    {% for person in chapter.editor.all %}
                        <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% endif %}
                {% if chapter.retoucher.all %}
                    <h1>Ретушёр:</h1>
                    {% for person in chapter.retoucher.all %}
                        <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% endif %}
                {% if chapter.typesetter.all %}
                    <h1>Верстальщик:</h1>
                    {% for person in chapter.typesetter.all %}
                        <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% endif %}
                {% if chapter.sfx_artist.all %}
                    <h1>Художник по звукам:</h1>
                    {% for person in chapter.sfx_artist.all %}
                        <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
            <!-- Включаем partial напрямую -->
            {% include 'partials/rating_block.html' with manga=manga chapter=chapter like_percentage=like_percentage user_rating=user_rating %}
            
        </div>
    
    </div>
    
{% endblock %}