import re
from django.utils.safestring import mark_safe
from django import template

register = template.Library()


@register.filter
def add_nbsp(value):
    if not value:
        return ""

    # Предлоги и союзы (неразрывный пробел ПОСЛЕ них)
    prepositions_conjunctions = r'в|во|на|над|под|за|из|от|до|по|о|об|обо|про|со|ко|изо|у|без|для|к|перед|при|через|сквозь|между|среди|вокруг|впереди|возле|мимо|вдоль|после|около|благодаря|ввиду|вследствие|вроде|наподобие|насчёт|включая|исключая|спустя|и|или|а|но|да|однако|зато|же|либо|то|не|то|ни|нибудь|либо|кое|ка|де|мол|будто|словно|точно|как|чем|нежели|чтоб|чтобы|ибо|потому|что|оттого|что|так|как|ли'

    # Частицы (неразрывный пробел ПЕРЕД ними)
    particles = r'ли|ль|неужели|разве|вот|вон|именно|прямо|точно|почти|единственно|только|лишь|исключительно|просто|хоть|хотя|бы|б|пусть|пускай|да|не|ни|нет|давай|давайте|ка|де|мол|дескать|скажем|положим|допустим|небось'

    patterns = [
        # Предлоги и союзы - неразрывный пробел ПОСЛЕ них
        (rf'(\s)({prepositions_conjunctions})(\s)', r'\1\2&nbsp;'),

        # Частицы - неразрывный пробел ПЕРЕД ними
        (rf'(\s)({particles})(\s)', r'&nbsp;\2\3'),

        # Тире - неразрывный пробел ПЕРЕД тире
        (r'(\s)(—)', r'&nbsp;\2'),

        # Сокращения - неразрывный пробел ПОСЛЕ них
        (r'(\s)(г\.|№|стр\.|с\.|т\.|д\.|пр\.|ул\.|пер\.|бул\.|ш\.|наб\.|пл\.|ал\.|просп\.|б\-р)(\s)', r'\1\2&nbsp;'),

        # Короткие слова (1-2 буквы) - неразрывный пробел ПОСЛЕ них
        (r'(\s)([а-яёa-z]{1,2})(\s)', r'\1\2&nbsp;'),
    ]

    # Применяем все паттерны
    for pattern, replacement in patterns:
        value = re.sub(pattern, replacement, value)

    return mark_safe(value)